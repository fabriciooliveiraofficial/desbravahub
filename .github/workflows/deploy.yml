name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      - name: Prepare Test Environment
        run: cp .env.testing .env

      - name: Run Tests
        run: vendor/bin/phpunit --testdox

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Production Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Test SSH Connectivity
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "Testando conexão SSH..."
          nc -zv -w 5 ${{ secrets.SSH_HOST }} ${{ secrets.SSH_PORT }} || echo "TIMEOUT: Não foi possível alcançar o servidor na porta ${{ secrets.SSH_PORT }}"

      - name: Deploy to Hostinger via rsync
        uses: Burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --exclude=.env --exclude=.env.* --exclude=.git* --exclude=.github* --exclude=tests --exclude=phpunit.xml --exclude=public/server-diag.php --exclude=public/test-api.php --exclude=public/fix-permissions.php
          rsh: ssh -p ${{ secrets.SSH_PORT }} -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o StrictHostKeyChecking=no
          path: ./
          remote_path: ${{ secrets.REMOTE_PATH }}
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_port: ${{ secrets.SSH_PORT }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Post-Deployment Steps
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.REMOTE_PATH }}
            php migrate-stripe.php 2>/dev/null || echo "Migration skipped or not found"
            echo "Deployment successful!"

